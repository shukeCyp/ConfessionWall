"use strict";const e=require("../../common/vendor.js"),o=require("../../common/assets.js"),n={data:()=>({isAgree:!1,apiBaseUrl:"https://confession.lyvideo.top"}),methods:{handleWXLogin(){this.isAgree?e.index.getUserInfo({success:o=>{console.log("用户信息：",o.userInfo);const n=o.userInfo;e.index.setStorageSync("avatarUrl",n.avatarUrl),e.index.setStorageSync("gender",n.gender),e.index.setStorageSync("nickName",n.nickName),this.wxLogin(n)},fail:o=>{console.error("获取用户信息失败：",o),e.index.showToast({title:"获取用户信息失败",icon:"none"})}}):e.index.showToast({title:"请先同意用户协议和隐私政策",icon:"none"})},wxLogin(o){e.index.login({provider:"weixin",success:n=>{const s=n.code;console.log("微信登录code:",s),e.index.request({url:`${this.apiBaseUrl}/wxcode2session?code=${s}`,method:"GET",success:n=>{if(console.log("登录接口返回数据：",n.data),n.data.success){const s=n.data.openid,i=n.data.unionid;e.index.setStorageSync("openid",s),e.index.setStorageSync("unionid",i),this.loginToServer(o,s,i)}else e.index.showToast({title:"登录失败",icon:"none"})},fail:o=>{console.error("接口调用失败：",o),e.index.showToast({title:"登录失败，请重试",icon:"none"})}})},fail:o=>{console.error("获取code失败：",o),e.index.showToast({title:"登录失败，请重试",icon:"none"})}})},loginToServer(o,n,s){const i={avatar_url:o.avatarUrl||null,gender:o.gender||0,nickname:o.nickName||null,openid:n,unionid:s||null};e.index.request({url:`${this.apiBaseUrl}/login`,method:"POST",header:{"Content-Type":"application/json"},data:i,success:o=>{200===o.statusCode?(e.index.setStorageSync("userId",o.data.id),e.index.showToast({title:"登录成功",icon:"success"}),setTimeout((()=>{e.index.reLaunch({url:"/pages/square/square"})}),1500)):e.index.showToast({title:"登录失败",icon:"none"})},fail:o=>{console.error("登录接口调用失败：",o),e.index.showToast({title:"登录失败，请重试",icon:"none"})}})},handleAgreeChange(e){this.isAgree=e.detail.value.length>0},goToUserAgreement(){},goToPrivacyPolicy(){}}};const s=e._export_sfc(n,[["render",function(n,s,i,t,r,a){return{a:o._imports_0,b:e.o(((...e)=>a.handleWXLogin&&a.handleWXLogin(...e))),c:r.isAgree,d:e.o(((...e)=>a.goToUserAgreement&&a.goToUserAgreement(...e))),e:e.o(((...e)=>a.goToPrivacyPolicy&&a.goToPrivacyPolicy(...e))),f:e.o(((...e)=>a.handleAgreeChange&&a.handleAgreeChange(...e)))}}]]);wx.createPage(s);
